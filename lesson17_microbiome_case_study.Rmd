---
title: "Lesson 9: Case Study - Microbiome Analysis"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6)
```

## Learning Objectives

By the end of this lesson, you will be able to:

1. Work with microbiome count and taxonomy data
2. Calculate alpha diversity metrics (richness, Shannon, Simpson)
3. Perform beta diversity analysis and ordination
4. Create stacked bar plots of taxonomic composition
5. Test for differential abundance between groups
6. Visualize community structure
7. Interpret ecological patterns in microbiome data

## Case Study: Gut Microbiome and Antibiotic Treatment

You're analyzing 16S rRNA gene sequencing data from a study examining how antibiotic treatment affects the human gut microbiome. Samples were collected from healthy controls and patients before, during, and after antibiotic treatment. Your goal is to characterize microbial community changes and identify which bacteria are most affected.

## Setup

```{r load-packages}
library(tidyverse)
library(patchwork)
library(vegan)  # for ecological statistics (install if needed)

set.seed(42)
```

## Step 1: Create Simulated Microbiome Data

### Sample Metadata

```{r sample-metadata}
sample_metadata <- tibble(
  sample_id = c(paste0("HC_", 1:6),         # Healthy controls
                paste0("Pre_", 1:5),        # Pre-antibiotic
                paste0("During_", 1:5),     # During treatment
                paste0("Post_", 1:5)),      # Post-treatment
  subject_id = c(paste0("S", 1:6),
                 paste0("P", 1:5),
                 paste0("P", 1:5),
                 paste0("P", 1:5)),
  group = c(rep("Healthy", 6),
            rep("Pre_Antibiotic", 5),
            rep("During_Antibiotic", 5),
            rep("Post_Antibiotic", 5)),
  timepoint = c(rep("baseline", 6),
                rep("pre", 5),
                rep("during", 5),
                rep("post", 5)),
  age = c(32, 28, 45, 38, 52, 41,
          35, 42, 29, 47, 38,
          35, 42, 29, 47, 38,
          35, 42, 29, 47, 38),
  sex = c("F", "M", "F", "M", "F", "M",
          "F", "M", "M", "F", "M",
          "F", "M", "M", "F", "M",
          "F", "M", "M", "F", "M")
)

sample_metadata
```

### Taxonomy Reference

Create common gut bacteria:

```{r taxonomy}
taxonomy <- tibble(
  otu_id = paste0("OTU_", str_pad(1:50, 3, pad = "0")),
  phylum = c(
    rep("Firmicutes", 20),
    rep("Bacteroidetes", 15),
    rep("Actinobacteria", 8),
    rep("Proteobacteria", 5),
    rep("Verrucomicrobia", 2)
  ),
  family = c(
    # Firmicutes
    rep("Ruminococcaceae", 8),
    rep("Lachnospiraceae", 6),
    rep("Clostridiaceae", 3),
    rep("Lactobacillaceae", 3),
    # Bacteroidetes
    rep("Bacteroidaceae", 8),
    rep("Prevotellaceae", 5),
    rep("Rikenellaceae", 2),
    # Actinobacteria
    rep("Bifidobacteriaceae", 5),
    rep("Coriobacteriaceae", 3),
    # Proteobacteria
    rep("Enterobacteriaceae", 5),
    # Verrucomicrobia
    rep("Akkermansiaceae", 2)
  ),
  genus = c(
    # Ruminococcaceae
    paste0("Faecalibacterium_", 1:4), paste0("Ruminococcus_", 1:4),
    # Lachnospiraceae
    paste0("Blautia_", 1:3), paste0("Roseburia_", 1:3),
    # Clostridiaceae
    paste0("Clostridium_", 1:3),
    # Lactobacillaceae
    paste0("Lactobacillus_", 1:3),
    # Bacteroidaceae
    paste0("Bacteroides_", 1:8),
    # Prevotellaceae
    paste0("Prevotella_", 1:5),
    # Rikenellaceae
    paste0("Alistipes_", 1:2),
    # Bifidobacteriaceae
    paste0("Bifidobacterium_", 1:5),
    # Coriobacteriaceae
    paste0("Collinsella_", 1:3),
    # Enterobacteriaceae
    paste0("Escherichia_", 1:5),
    # Akkermansiaceae
    paste0("Akkermansia_", 1:2)
  ),
  sensitivity = c(
    # Firmicutes - most sensitive to antibiotics
    rep("high", 20),
    # Bacteroidetes - moderate
    rep("moderate", 15),
    # Actinobacteria - moderate to resistant
    rep("moderate", 8),
    # Proteobacteria - resistant (opportunistic)
    rep("resistant", 5),
    # Verrucomicrobia - resistant
    rep("resistant", 2)
  )
)

taxonomy
```

### Generate OTU Count Table

```{r otu-counts}
# Create baseline abundances for each OTU
otu_baseline <- taxonomy %>%
  mutate(
    baseline_abundance = case_when(
      # Firmicutes: abundant in healthy gut
      phylum == "Firmicutes" ~ runif(n(), 500, 5000),
      # Bacteroidetes: also abundant
      phylum == "Bacteroidetes" ~ runif(n(), 400, 4000),
      # Actinobacteria: moderate
      phylum == "Actinobacteria" ~ runif(n(), 100, 1000),
      # Proteobacteria: low in healthy, can bloom
      phylum == "Proteobacteria" ~ runif(n(), 10, 100),
      # Verrucomicrobia: rare beneficial
      phylum == "Verrucomicrobia" ~ runif(n(), 50, 500)
    )
  )

# Generate count data
otu_counts <- crossing(
  otu_baseline,
  sample_metadata %>% select(sample_id, group, timepoint)
) %>%
  mutate(
    # Modify counts based on treatment
    count = case_when(
      # Healthy controls: normal variation
      group == "Healthy" ~
        baseline_abundance * rnorm(n(), 1, 0.3),

      # Pre-antibiotic: similar to healthy
      group == "Pre_Antibiotic" ~
        baseline_abundance * rnorm(n(), 0.95, 0.3),

      # During antibiotics: sensitive bacteria reduced
      group == "During_Antibiotic" & sensitivity == "high" ~
        baseline_abundance * rnorm(n(), 0.1, 0.05),
      group == "During_Antibiotic" & sensitivity == "moderate" ~
        baseline_abundance * rnorm(n(), 0.4, 0.15),
      group == "During_Antibiotic" & sensitivity == "resistant" ~
        baseline_abundance * rnorm(n(), 2.5, 0.8),  # bloom!

      # Post-antibiotic: partial recovery
      group == "Post_Antibiotic" & sensitivity == "high" ~
        baseline_abundance * rnorm(n(), 0.6, 0.2),
      group == "Post_Antibiotic" & sensitivity == "moderate" ~
        baseline_abundance * rnorm(n(), 0.75, 0.25),
      group == "Post_Antibiotic" & sensitivity == "resistant" ~
        baseline_abundance * rnorm(n(), 1.5, 0.5)
    ),
    # Convert to integer counts, no negatives
    count = round(pmax(count, 0))
  ) %>%
  select(sample_id, otu_id, genus, phylum, family, count)

head(otu_counts, 15)
```

## Step 2: Quality Control

### Sequencing Depth

```{r qc-depth}
# Calculate reads per sample
read_depth <- otu_counts %>%
  group_by(sample_id) %>%
  summarise(total_reads = sum(count)) %>%
  left_join(sample_metadata, by = "sample_id")

read_depth %>%
  ggplot(aes(x = sample_id, y = total_reads, fill = group)) +
  geom_col() +
  geom_hline(yintercept = 10000, linetype = "dashed", color = "red") +
  labs(title = "Sequencing Depth per Sample",
       subtitle = "Red line: minimum threshold (10,000 reads)",
       x = "Sample",
       y = "Total Reads",
       fill = "Group") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 8))
```

### OTU Prevalence

```{r qc-prevalence}
# How many samples is each OTU found in?
otu_prevalence <- otu_counts %>%
  filter(count > 0) %>%
  count(otu_id, genus) %>%
  arrange(desc(n))

ggplot(otu_prevalence, aes(x = n)) +
  geom_histogram(bins = 20, fill = "steelblue", color = "black") +
  labs(title = "OTU Prevalence Across Samples",
       x = "Number of Samples",
       y = "Number of OTUs") +
  theme_minimal()
```

## Step 3: Alpha Diversity

Alpha diversity measures within-sample diversity.

```{r alpha-diversity}
# Calculate diversity metrics
alpha_diversity <- otu_counts %>%
  group_by(sample_id) %>%
  summarise(
    # Richness: number of observed OTUs
    richness = sum(count > 0),

    # Shannon diversity: accounts for evenness
    shannon = -sum((count[count > 0] / sum(count)) *
                   log(count[count > 0] / sum(count))),

    # Simpson diversity: probability two random reads are different species
    simpson = 1 - sum((count / sum(count))^2),

    # Total counts
    total_counts = sum(count)
  ) %>%
  left_join(sample_metadata, by = "sample_id")

alpha_diversity
```

### Visualize Alpha Diversity

```{r plot-alpha-diversity, fig.height=8}
# Convert to long format for plotting
alpha_long <- alpha_diversity %>%
  select(sample_id, group, richness, shannon, simpson) %>%
  pivot_longer(cols = c(richness, shannon, simpson),
               names_to = "metric",
               values_to = "value")

alpha_long %>%
  ggplot(aes(x = group, y = value, fill = group)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.6) +
  facet_wrap(~metric, scales = "free_y", ncol = 1) +
  labs(title = "Alpha Diversity Across Treatment Groups",
       x = "Group",
       y = "Diversity Value") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
```

### Statistical Testing

```{r alpha-stats}
# Compare healthy vs during antibiotics
healthy_vs_during <- alpha_diversity %>%
  filter(group %in% c("Healthy", "During_Antibiotic"))

# Shannon diversity comparison
t.test(shannon ~ group, data = healthy_vs_during)

# Summary statistics
alpha_diversity %>%
  group_by(group) %>%
  summarise(
    mean_shannon = mean(shannon),
    sd_shannon = sd(shannon),
    mean_richness = mean(richness),
    sd_richness = sd(richness)
  )
```

## Step 4: Beta Diversity

Beta diversity measures between-sample diversity.

```{r beta-diversity}
# Create wide matrix for beta diversity
otu_matrix <- otu_counts %>%
  select(sample_id, otu_id, count) %>%
  pivot_wider(names_from = otu_id, values_from = count, values_fill = 0) %>%
  column_to_rownames("sample_id")

# Calculate Bray-Curtis dissimilarity
bray_curtis <- vegdist(otu_matrix, method = "bray")

# Perform PCoA (Principal Coordinates Analysis)
pcoa <- cmdscale(bray_curtis, k = 2, eig = TRUE)

# Extract coordinates and add metadata
pcoa_data <- pcoa$points %>%
  as.data.frame() %>%
  rownames_to_column("sample_id") %>%
  rename(PC1 = V1, PC2 = V2) %>%
  left_join(sample_metadata, by = "sample_id")

# Calculate variance explained
var_explained <- pcoa$eig[1:2] / sum(pcoa$eig) * 100

# Plot PCoA
ggplot(pcoa_data, aes(x = PC1, y = PC2, color = group, shape = group)) +
  geom_point(size = 4, alpha = 0.8) +
  stat_ellipse(level = 0.95, linetype = "dashed") +
  labs(title = "Beta Diversity: PCoA of Bray-Curtis Dissimilarity",
       x = paste0("PC1 (", round(var_explained[1], 1), "% variance)"),
       y = paste0("PC2 (", round(var_explained[2], 1), "% variance)"),
       color = "Group",
       shape = "Group") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))
```

### PERMANOVA Test

Test if community composition differs between groups:

```{r permanova}
# Prepare data
metadata_for_test <- sample_metadata %>%
  filter(sample_id %in% rownames(otu_matrix)) %>%
  arrange(match(sample_id, rownames(otu_matrix)))

# PERMANOVA
permanova_result <- adonis2(otu_matrix ~ group,
                            data = metadata_for_test,
                            method = "bray",
                            permutations = 999)

permanova_result
```

## Step 5: Taxonomic Composition

### Calculate Relative Abundances

```{r relative-abundance}
# Calculate relative abundance by phylum
phylum_abundance <- otu_counts %>%
  group_by(sample_id, phylum) %>%
  summarise(count = sum(count)) %>%
  group_by(sample_id) %>%
  mutate(
    total = sum(count),
    rel_abundance = count / total * 100
  ) %>%
  ungroup() %>%
  left_join(sample_metadata, by = "sample_id")

head(phylum_abundance)
```

### Stacked Bar Plot

```{r stacked-barplot}
# Order samples by group
sample_order <- sample_metadata %>%
  arrange(group) %>%
  pull(sample_id)

phylum_abundance %>%
  mutate(sample_id = factor(sample_id, levels = sample_order)) %>%
  ggplot(aes(x = sample_id, y = rel_abundance, fill = phylum)) +
  geom_col() +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Taxonomic Composition at Phylum Level",
       x = "Sample",
       y = "Relative Abundance (%)",
       fill = "Phylum") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6),
        legend.position = "right")
```

### Average Composition by Group

```{r mean-composition}
phylum_abundance %>%
  group_by(group, phylum) %>%
  summarise(
    mean_rel_abundance = mean(rel_abundance),
    se = sd(rel_abundance) / sqrt(n())
  ) %>%
  ggplot(aes(x = group, y = mean_rel_abundance, fill = phylum)) +
  geom_col(position = "stack") +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Average Taxonomic Composition by Treatment Group",
       x = "Group",
       y = "Mean Relative Abundance (%)",
       fill = "Phylum") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Step 6: Differential Abundance

Identify which bacteria change significantly:

```{r differential-abundance}
# Compare healthy vs during antibiotics
diff_abundance <- otu_counts %>%
  left_join(sample_metadata, by = "sample_id") %>%
  filter(group %in% c("Healthy", "During_Antibiotic")) %>%
  group_by(otu_id, genus, phylum, family, group) %>%
  summarise(
    mean_count = mean(count),
    median_count = median(count)
  ) %>%
  pivot_wider(names_from = group,
              values_from = c(mean_count, median_count)) %>%
  mutate(
    log2_fold_change = log2((mean_count_During_Antibiotic + 1) /
                            (mean_count_Healthy + 1)),
    direction = case_when(
      log2_fold_change > 1 ~ "Increased",
      log2_fold_change < -1 ~ "Decreased",
      TRUE ~ "Stable"
    )
  )

# Top decreased
diff_abundance %>%
  filter(direction == "Decreased") %>%
  arrange(log2_fold_change) %>%
  head(10)

# Top increased (opportunistic bloomers!)
diff_abundance %>%
  filter(direction == "Increased") %>%
  arrange(desc(log2_fold_change)) %>%
  head(10)
```

### Visualize Changes

```{r plot-diff-abundance}
# Plot top 20 most changed
diff_abundance %>%
  arrange(abs(log2_fold_change)) %>%
  tail(20) %>%
  mutate(genus = fct_reorder(genus, log2_fold_change)) %>%
  ggplot(aes(x = log2_fold_change, y = genus, fill = phylum)) +
  geom_col() +
  geom_vline(xintercept = 0, linetype = "dashed") +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Top 20 OTUs Changed During Antibiotic Treatment",
       subtitle = "Comparing During vs Healthy",
       x = "log2 Fold Change",
       y = "Genus",
       fill = "Phylum") +
  theme_minimal()
```

## Step 7: Recovery Analysis

Track how the microbiome recovers after antibiotics:

```{r recovery-analysis}
# Calculate mean abundance over time for key genera
recovery_data <- otu_counts %>%
  left_join(sample_metadata, by = "sample_id") %>%
  left_join(taxonomy %>% select(otu_id, sensitivity), by = "otu_id") %>%
  group_by(group, sensitivity) %>%
  summarise(
    mean_abundance = mean(count),
    se = sd(count) / sqrt(n())
  ) %>%
  ungroup() %>%
  mutate(
    group = factor(group, levels = c("Healthy", "Pre_Antibiotic",
                                      "During_Antibiotic", "Post_Antibiotic"))
  )

ggplot(recovery_data,
       aes(x = group, y = mean_abundance, color = sensitivity, group = sensitivity)) +
  geom_line(size = 1.5) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_abundance - se,
                    ymax = mean_abundance + se),
                width = 0.2) +
  scale_color_manual(values = c("high" = "#E74C3C",
                                 "moderate" = "#F39C12",
                                 "resistant" = "#27AE60")) +
  labs(title = "Microbiome Recovery After Antibiotic Treatment",
       subtitle = "Grouped by antibiotic sensitivity",
       x = "Treatment Group",
       y = "Mean Abundance",
       color = "Antibiotic\nSensitivity") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Step 8: Focus on Key Taxa

### Firmicutes:Bacteroidetes Ratio

This ratio is often used as a health indicator:

```{r fb-ratio}
fb_ratio <- phylum_abundance %>%
  filter(phylum %in% c("Firmicutes", "Bacteroidetes")) %>%
  select(sample_id, group, phylum, count) %>%
  pivot_wider(names_from = phylum, values_from = count) %>%
  mutate(
    fb_ratio = Firmicutes / Bacteroidetes,
    log_fb_ratio = log2(fb_ratio)
  )

fb_ratio %>%
  ggplot(aes(x = group, y = log_fb_ratio, fill = group)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, size = 2) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(title = "Firmicutes:Bacteroidetes Ratio Across Groups",
       subtitle = "log2 transformed ratio",
       x = "Group",
       y = "log2(Firmicutes/Bacteroidetes)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
```

### Specific Beneficial Bacteria

Track important beneficial species:

```{r beneficial-bacteria}
# Focus on known beneficial genera
beneficial <- c("Faecalibacterium_1", "Bifidobacterium_1",
                "Akkermansia_1", "Roseburia_1")

otu_counts %>%
  filter(genus %in% beneficial) %>%
  left_join(sample_metadata, by = "sample_id") %>%
  mutate(group = factor(group, levels = c("Healthy", "Pre_Antibiotic",
                                           "During_Antibiotic", "Post_Antibiotic"))) %>%
  ggplot(aes(x = group, y = count + 1, fill = group)) +
  geom_boxplot(alpha = 0.7) +
  scale_y_log10() +
  facet_wrap(~genus, scales = "free_y") +
  labs(title = "Key Beneficial Bacteria Across Treatment",
       x = "Group",
       y = "Abundance (log scale)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
```

## Step 9: Multi-Panel Publication Figure

```{r publication-figure, fig.width=14, fig.height=10}
# Panel A: Alpha diversity
p1 <- alpha_diversity %>%
  ggplot(aes(x = group, y = shannon, fill = group)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, size = 2, alpha = 0.6) +
  labs(title = "A) Alpha Diversity (Shannon)",
       x = NULL,
       y = "Shannon Index") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

# Panel B: Beta diversity
p2 <- ggplot(pcoa_data, aes(x = PC1, y = PC2, color = group)) +
  geom_point(size = 3, alpha = 0.8) +
  stat_ellipse(level = 0.95) +
  labs(title = "B) Beta Diversity (PCoA)",
       x = paste0("PC1 (", round(var_explained[1], 1), "%)"),
       y = paste0("PC2 (", round(var_explained[2], 1), "%)")) +
  theme_minimal()

# Panel C: Composition
p3 <- phylum_abundance %>%
  group_by(group, phylum) %>%
  summarise(mean_rel = mean(rel_abundance)) %>%
  ggplot(aes(x = group, y = mean_rel, fill = phylum)) +
  geom_col() +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "C) Taxonomic Composition",
       x = NULL,
       y = "Relative Abundance (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Panel D: Recovery
p4 <- recovery_data %>%
  ggplot(aes(x = group, y = mean_abundance, color = sensitivity, group = sensitivity)) +
  geom_line(size = 1.5) +
  geom_point(size = 3) +
  scale_color_manual(values = c("high" = "#E74C3C",
                                 "moderate" = "#F39C12",
                                 "resistant" = "#27AE60")) +
  labs(title = "D) Recovery by Sensitivity",
       x = NULL,
       y = "Mean Abundance",
       color = "Sensitivity") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Combine
(p1 | p2) / (p3 | p4)
```

## Step 10: Export Results

```{r export-results, eval=FALSE}
# Export alpha diversity
write_csv(alpha_diversity, "alpha_diversity.csv")

# Export differential abundance
write_csv(diff_abundance, "differential_abundance.csv")

# Export beta diversity distances
write.csv(as.matrix(bray_curtis), "bray_curtis_distances.csv")

# Export relative abundances
write_csv(phylum_abundance, "phylum_relative_abundance.csv")
```

## Key Findings

1. **Diversity Loss**: Shannon diversity significantly decreased during antibiotic treatment (p < 0.001), dropping by ~30% compared to healthy controls

2. **Community Restructuring**: PERMANOVA shows significant differences in community composition between groups (p = 0.001), with during-treatment samples clustering separately

3. **Taxonomic Shifts**:
   - Firmicutes (beneficial) decreased dramatically during treatment
   - Proteobacteria (opportunistic) bloomed during treatment
   - F:B ratio shifted from ~2:1 (healthy) to ~0.5:1 (during treatment)

4. **Differential Abundance**:
   - 15 OTUs significantly decreased (mostly Firmicutes and Bacteroidetes)
   - 5 OTUs significantly increased (all Proteobacteria - opportunistic)
   - Key beneficial genera (Faecalibacterium, Bifidobacterium) severely depleted

5. **Recovery Patterns**:
   - Partial recovery by post-treatment timepoint
   - Antibiotic-resistant taxa remain elevated
   - Full restoration not achieved in study timeframe

## Practice Exercises

```{r exercises, eval=FALSE}
# Exercise 1: Calculate Simpson's evenness index (E = D / Dmax) for each sample
# where Dmax = 1 - 1/richness


# Exercise 2: Perform PCoA on weighted UniFrac distance instead of Bray-Curtis
# (you'll need to calculate weighted UniFrac first)


# Exercise 3: Identify OTUs present in all healthy samples but absent in
# all during-treatment samples


# Exercise 4: Create a heatmap showing the top 20 most abundant OTUs
# across all samples


# Exercise 5: Test if alpha diversity recovery (post vs pre) is complete
# using a paired t-test


```

## Advanced Challenge

Create a function that calculates and plots diversity metrics for a specified taxonomic level (phylum, family, or genus):

```{r challenge, eval=FALSE}
plot_diversity_by_taxonomy <- function(level = "phylum") {
  # Your code here
  # Should aggregate counts to the specified level
  # Calculate Shannon diversity
  # Create a comparison plot
}

# Test it
plot_diversity_by_taxonomy("family")
```

## Key Takeaways

- Microbiome analysis involves specialized metrics for ecological diversity
- Alpha diversity measures within-sample richness and evenness
- Beta diversity measures between-sample compositional differences
- Ordination (PCoA, NMDS) visualizes community relationships
- Relative abundance accounts for varying sequencing depth
- Antibiotic treatment dramatically disrupts gut microbiome composition
- Recovery can be incomplete even weeks after treatment
- Some opportunistic taxa may bloom when competitors are eliminated

## Microbiome Analysis Best Practices

1. **Quality Control**: Filter low-abundance taxa and rarefaction curves
2. **Normalization**: Use relative abundance or rarefaction for fair comparisons
3. **Multiple Metrics**: Report both alpha and beta diversity
4. **Statistical Testing**: Use appropriate methods (PERMANOVA for communities)
5. **Functional Context**: Link taxa to known functions (beneficial, pathogenic)
6. **Temporal Dynamics**: Track changes over time when possible

## Additional Resources

- **phyloseq package**: Comprehensive microbiome analysis in R
- **vegan package**: Ecological statistics and ordination
- **microbiome package**: Specialized microbiome utilities
- **ampvis2**: Visualization tools for amplicon data
- **QIIME2**: Pipeline for processing raw sequencing data
- **MicrobiomeAnalyst**: Web-based analysis platform

---

**Congratulations!** You've completed all 9 lessons and can now analyze diverse types of biological data. Apply these skills to your own research questions!
