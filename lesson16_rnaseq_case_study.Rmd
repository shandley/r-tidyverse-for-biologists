---
title: "Lesson 8: Case Study - RNA-seq Gene Expression Analysis"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6)
```

## Learning Objectives

By the end of this lesson, you will be able to:

1. Work with gene expression count data
2. Perform quality control on RNA-seq samples
3. Identify differentially expressed genes
4. Create volcano plots and heatmaps
5. Perform principal component analysis (PCA)
6. Visualize gene expression patterns
7. Integrate functional annotations

## Case Study: Host Response to Viral Infection

You're analyzing RNA-seq data from a study of human cells infected with a respiratory virus. Samples were collected at 0h (mock infection), 8h, and 24h post-infection, with 3 biological replicates each. Your goal is to identify genes that respond to infection and understand the temporal dynamics.

## Setup

```{r load-packages}
library(tidyverse)
library(patchwork)
library(pheatmap)  # for heatmaps (install if needed)

set.seed(123)
```

## Step 1: Create Simulated RNA-seq Data

### Sample Metadata

```{r sample-metadata}
sample_info <- tibble(
  sample_id = c("mock_1", "mock_2", "mock_3",
                "inf_8h_1", "inf_8h_2", "inf_8h_3",
                "inf_24h_1", "inf_24h_2", "inf_24h_3"),
  condition = rep(c("mock", "infected_8h", "infected_24h"), each = 3),
  time_point = rep(c(0, 8, 24), each = 3),
  replicate = rep(1:3, times = 3),
  total_reads = c(25e6, 23e6, 26e6,  # mock
                  24e6, 25e6, 23e6,  # 8h
                  22e6, 24e6, 23e6)  # 24h
)

sample_info
```

### Gene Count Data

In real RNA-seq, you have thousands of genes. We'll simulate a smaller set:

```{r gene-counts}
# Create gene IDs and categories
n_genes <- 100

gene_info <- tibble(
  gene_id = paste0("GENE_", str_pad(1:n_genes, 4, pad = "0")),
  gene_name = c(
    # Immune response genes (upregulated in infection)
    paste0("IMMUNE_", 1:20),
    # Interferon-stimulated genes (strongly upregulated)
    paste0("ISG_", 1:15),
    # Viral response genes (time-dependent)
    paste0("ANTIVIRAL_", 1:10),
    # Housekeeping genes (stable expression)
    paste0("HOUSEKEEP_", 1:15),
    # Downregulated genes
    paste0("METAB_", 1:10),
    # Not differentially expressed
    paste0("OTHER_", 1:30)
  ),
  gene_type = c(
    rep("immune_response", 20),
    rep("interferon_stimulated", 15),
    rep("antiviral", 10),
    rep("housekeeping", 15),
    rep("metabolism", 10),
    rep("other", 30)
  ),
  baseline_expression = c(
    runif(20, 100, 500),    # immune
    runif(15, 50, 200),     # ISG
    runif(10, 80, 300),     # antiviral
    runif(15, 1000, 3000),  # housekeeping (high baseline)
    runif(10, 200, 800),    # metabolism
    runif(30, 50, 500)      # other
  )
)

# Generate count matrix
count_data <- gene_info %>%
  select(gene_id, gene_name, gene_type, baseline_expression) %>%
  crossing(sample_info %>% select(sample_id, condition, time_point)) %>%
  mutate(
    # Simulate counts based on gene type and condition
    counts = case_when(
      # Immune response: moderate increase
      gene_type == "immune_response" & condition == "infected_8h" ~
        baseline_expression * runif(n(), 2, 4),
      gene_type == "immune_response" & condition == "infected_24h" ~
        baseline_expression * runif(n(), 4, 8),

      # ISG: strong increase
      gene_type == "interferon_stimulated" & condition == "infected_8h" ~
        baseline_expression * runif(n(), 5, 10),
      gene_type == "interferon_stimulated" & condition == "infected_24h" ~
        baseline_expression * runif(n(), 10, 20),

      # Antiviral: time-dependent (stronger at 24h)
      gene_type == "antiviral" & condition == "infected_8h" ~
        baseline_expression * runif(n(), 1.5, 3),
      gene_type == "antiviral" & condition == "infected_24h" ~
        baseline_expression * runif(n(), 6, 12),

      # Metabolism: downregulated
      gene_type == "metabolism" & condition == "infected_8h" ~
        baseline_expression * runif(n(), 0.5, 0.8),
      gene_type == "metabolism" & condition == "infected_24h" ~
        baseline_expression * runif(n(), 0.3, 0.6),

      # Others: stable or slight variation
      TRUE ~ baseline_expression * runif(n(), 0.8, 1.2)
    ),
    # Round to integer counts and add noise
    counts = round(counts * rnorm(n(), 1, 0.1)),
    counts = pmax(counts, 0)  # no negative counts
  )

head(count_data, 15)
```

## Step 2: Quality Control

### Library Size (Total Reads)

```{r qc-library-size}
sample_info %>%
  ggplot(aes(x = sample_id, y = total_reads / 1e6, fill = condition)) +
  geom_col() +
  labs(title = "Library Sizes Across Samples",
       x = "Sample",
       y = "Total Reads (millions)",
       fill = "Condition") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Distribution of Gene Expression

```{r qc-distribution}
count_data %>%
  filter(counts > 0) %>%  # Remove zero counts for log scale
  ggplot(aes(x = log10(counts + 1), color = condition)) +
  geom_density(size = 1) +
  facet_wrap(~sample_id) +
  labs(title = "Distribution of Gene Expression Across Samples",
       x = "log10(counts + 1)",
       y = "Density") +
  theme_minimal()
```

## Step 3: Normalization

RNA-seq counts need normalization. We'll calculate TPM (Transcripts Per Million) simplified version:

```{r normalization}
# Calculate normalized expression (simplified TPM-like)
normalized_counts <- count_data %>%
  group_by(sample_id) %>%
  mutate(
    total_counts = sum(counts),
    tpm = (counts / total_counts) * 1e6
  ) %>%
  ungroup()

# Check that TPM sums to ~1 million per sample
normalized_counts %>%
  group_by(sample_id) %>%
  summarise(total_tpm = sum(tpm))
```

## Step 4: Principal Component Analysis (PCA)

PCA helps visualize overall sample relationships:

```{r pca}
# Create wide matrix for PCA (genes as rows, samples as columns)
count_matrix_wide <- count_data %>%
  select(gene_id, sample_id, counts) %>%
  pivot_wider(names_from = sample_id, values_from = counts) %>%
  column_to_rownames("gene_id")

# Log transform (adding pseudocount to avoid log(0))
log_counts <- log2(count_matrix_wide + 1)

# Perform PCA (transpose so samples are rows)
pca_result <- prcomp(t(log_counts), scale. = TRUE)

# Extract PC scores and add metadata
pca_data <- pca_result$x %>%
  as.data.frame() %>%
  rownames_to_column("sample_id") %>%
  left_join(sample_info, by = "sample_id")

# Calculate variance explained
var_explained <- summary(pca_result)$importance[2, 1:2] * 100

# Plot PCA
ggplot(pca_data, aes(x = PC1, y = PC2, color = condition, shape = condition)) +
  geom_point(size = 4) +
  stat_ellipse(level = 0.95, linetype = "dashed") +
  labs(title = "PCA of RNA-seq Samples",
       x = paste0("PC1 (", round(var_explained[1], 1), "% variance)"),
       y = paste0("PC2 (", round(var_explained[2], 1), "% variance)"),
       color = "Condition",
       shape = "Condition") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))
```

## Step 5: Differential Expression Analysis

### Calculate Fold Changes and Statistics

```{r diff-expression}
# Calculate mean expression per condition
mean_expression <- count_data %>%
  group_by(gene_id, gene_name, gene_type, condition) %>%
  summarise(
    mean_counts = mean(counts),
    sd_counts = sd(counts),
    n = n()
  ) %>%
  ungroup()

# Calculate fold changes (infected vs mock)
fold_changes_8h <- mean_expression %>%
  select(gene_id, gene_name, gene_type, condition, mean_counts) %>%
  pivot_wider(names_from = condition, values_from = mean_counts) %>%
  mutate(
    log2_fc_8h = log2((infected_8h + 1) / (mock + 1)),
    avg_expression = (infected_8h + mock) / 2
  )

fold_changes_24h <- mean_expression %>%
  select(gene_id, gene_name, gene_type, condition, mean_counts) %>%
  pivot_wider(names_from = condition, values_from = mean_counts) %>%
  mutate(
    log2_fc_24h = log2((infected_24h + 1) / (mock + 1)),
    avg_expression = (infected_24h + mock) / 2
  )

# Simplified significance test (t-test for each gene at 8h)
de_results_8h <- count_data %>%
  filter(condition %in% c("mock", "infected_8h")) %>%
  group_by(gene_id, gene_name, gene_type) %>%
  summarise(
    p_value = if(n() >= 6) {
      t.test(counts[condition == "infected_8h"],
             counts[condition == "mock"])$p.value
    } else { NA_real_ }
  ) %>%
  ungroup() %>%
  mutate(
    p_adjusted = p.adjust(p_value, method = "BH"),
    significant = p_adjusted < 0.05
  ) %>%
  left_join(fold_changes_8h %>% select(gene_id, log2_fc_8h, avg_expression),
            by = "gene_id")

head(de_results_8h %>% arrange(p_adjusted), 10)
```

### How Many Genes Are Differentially Expressed?

```{r de-summary}
de_results_8h %>%
  filter(!is.na(significant)) %>%
  count(significant)

# By gene type
de_results_8h %>%
  filter(!is.na(significant)) %>%
  count(gene_type, significant) %>%
  pivot_wider(names_from = significant, values_from = n, values_fill = 0)
```

## Step 6: Volcano Plot

The classic visualization for differential expression:

```{r volcano-plot}
de_results_8h %>%
  filter(!is.na(p_adjusted)) %>%
  mutate(
    significance = case_when(
      p_adjusted < 0.05 & abs(log2_fc_8h) > 1 ~ "Significant (FC > 2)",
      p_adjusted < 0.05 ~ "Significant (FC < 2)",
      TRUE ~ "Not significant"
    )
  ) %>%
  ggplot(aes(x = log2_fc_8h, y = -log10(p_adjusted), color = significance)) +
  geom_point(alpha = 0.6, size = 2) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "gray50") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "gray50") +
  scale_color_manual(values = c("Significant (FC > 2)" = "red",
                                 "Significant (FC < 2)" = "orange",
                                 "Not significant" = "gray70")) +
  labs(title = "Volcano Plot: Infected (8h) vs Mock",
       subtitle = "Red: FDR < 0.05 and |log2FC| > 1",
       x = "log2 Fold Change",
       y = "-log10 Adjusted P-value",
       color = "Status") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))
```

## Step 7: Heatmap of Top Genes

```{r heatmap, fig.height=8}
# Get top 30 most significantly changed genes
top_genes <- de_results_8h %>%
  filter(!is.na(p_adjusted)) %>%
  arrange(p_adjusted) %>%
  head(30) %>%
  pull(gene_id)

# Create matrix for heatmap
heatmap_data <- count_data %>%
  filter(gene_id %in% top_genes) %>%
  group_by(gene_id) %>%
  mutate(
    # Z-score normalization across samples
    z_score = scale(log2(counts + 1))[,1]
  ) %>%
  ungroup() %>%
  select(gene_name, sample_id, z_score) %>%
  pivot_wider(names_from = sample_id, values_from = z_score) %>%
  column_to_rownames("gene_name")

# Create annotation for samples
sample_annotation <- sample_info %>%
  select(sample_id, condition) %>%
  column_to_rownames("sample_id")

# Create heatmap
pheatmap(heatmap_data,
         annotation_col = sample_annotation,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         show_rownames = TRUE,
         show_colnames = TRUE,
         color = colorRampPalette(c("blue", "white", "red"))(100),
         main = "Top 30 Differentially Expressed Genes",
         fontsize_row = 8)
```

## Step 8: Time Course Analysis

Compare early (8h) vs late (24h) response:

```{r time-course}
# Get genes significant at either timepoint
time_course_genes <- de_results_8h %>%
  filter(p_adjusted < 0.05, abs(log2_fc_8h) > 1) %>%
  pull(gene_id)

# Calculate mean expression across time
time_course_data <- count_data %>%
  filter(gene_id %in% time_course_genes) %>%
  group_by(gene_name, gene_type, time_point) %>%
  summarise(
    mean_log2_counts = mean(log2(counts + 1)),
    se = sd(log2(counts + 1)) / sqrt(n())
  ) %>%
  ungroup()

# Plot time course by gene type
time_course_data %>%
  filter(gene_type %in% c("immune_response", "interferon_stimulated",
                          "antiviral", "metabolism")) %>%
  ggplot(aes(x = time_point, y = mean_log2_counts,
             group = gene_name, color = gene_type)) +
  geom_line(alpha = 0.5) +
  geom_point() +
  facet_wrap(~gene_type, scales = "free_y") +
  labs(title = "Expression Dynamics of Differentially Expressed Genes",
       x = "Time Post-Infection (hours)",
       y = "Mean log2(counts + 1)",
       color = "Gene Type") +
  theme_minimal() +
  theme(legend.position = "none")
```

## Step 9: Gene Set Analysis

Group genes by function and analyze patterns:

```{r gene-set-analysis}
# Average expression by gene type and condition
gene_set_summary <- count_data %>%
  group_by(gene_type, condition) %>%
  summarise(
    mean_expression = mean(log2(counts + 1)),
    se = sd(log2(counts + 1)) / sqrt(n()),
    n_genes = n_distinct(gene_id)
  ) %>%
  ungroup()

gene_set_summary

# Visualize
gene_set_summary %>%
  filter(gene_type != "other") %>%
  ggplot(aes(x = condition, y = mean_expression, fill = condition)) +
  geom_col() +
  geom_errorbar(aes(ymin = mean_expression - se,
                    ymax = mean_expression + se),
                width = 0.2) +
  facet_wrap(~gene_type, scales = "free_y") +
  labs(title = "Average Expression by Gene Function",
       x = "Condition",
       y = "Mean log2(counts + 1)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
```

## Step 10: Specific Gene Profiles

Examine individual genes of interest:

```{r specific-genes, fig.height=8}
# Select interesting genes
genes_of_interest <- de_results_8h %>%
  arrange(p_adjusted) %>%
  slice(1:12) %>%
  pull(gene_name)

# Plot expression profiles
count_data %>%
  filter(gene_name %in% genes_of_interest) %>%
  left_join(sample_info, by = "sample_id") %>%
  ggplot(aes(x = time_point, y = log2(counts + 1),
             color = condition, group = condition)) +
  geom_point(size = 2) +
  geom_line(stat = "summary", fun = mean, size = 1) +
  facet_wrap(~gene_name, scales = "free_y", ncol = 3) +
  labs(title = "Expression Profiles of Top 12 Genes",
       x = "Time (hours)",
       y = "log2(counts + 1)",
       color = "Condition") +
  theme_minimal()
```

## Step 11: Multi-Panel Publication Figure

```{r publication-figure, fig.width=14, fig.height=10}
# Panel A: PCA
p1 <- ggplot(pca_data, aes(x = PC1, y = PC2, color = condition)) +
  geom_point(size = 4) +
  stat_ellipse(level = 0.95) +
  labs(title = "A) Principal Component Analysis",
       x = paste0("PC1 (", round(var_explained[1], 1), "%)"),
       y = paste0("PC2 (", round(var_explained[2], 1), "%)")) +
  theme_minimal() +
  theme(legend.position = "right")

# Panel B: Volcano plot
p2 <- de_results_8h %>%
  filter(!is.na(p_adjusted)) %>%
  mutate(sig = p_adjusted < 0.05 & abs(log2_fc_8h) > 1) %>%
  ggplot(aes(x = log2_fc_8h, y = -log10(p_adjusted), color = sig)) +
  geom_point(alpha = 0.5) +
  scale_color_manual(values = c("TRUE" = "red", "FALSE" = "gray70")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  labs(title = "B) Differential Expression (8h vs Mock)",
       x = "log2 Fold Change",
       y = "-log10 Adjusted P-value") +
  theme_minimal() +
  theme(legend.position = "none")

# Panel C: Gene type enrichment
p3 <- de_results_8h %>%
  filter(!is.na(significant), gene_type != "other") %>%
  count(gene_type, significant) %>%
  ggplot(aes(x = gene_type, y = n, fill = significant)) +
  geom_col(position = "dodge") +
  labs(title = "C) Differential Expression by Gene Type",
       x = "Gene Type",
       y = "Number of Genes",
       fill = "Significant") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Panel D: Time course
p4 <- time_course_data %>%
  filter(gene_type %in% c("immune_response", "interferon_stimulated")) %>%
  group_by(gene_type, time_point) %>%
  summarise(mean_expr = mean(mean_log2_counts),
            se = sd(mean_log2_counts) / sqrt(n())) %>%
  ggplot(aes(x = time_point, y = mean_expr, color = gene_type)) +
  geom_line(size = 1.5) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_expr - se, ymax = mean_expr + se), width = 1) +
  labs(title = "D) Temporal Expression Dynamics",
       x = "Time (hours)",
       y = "Mean log2 Expression",
       color = "Gene Type") +
  theme_minimal()

# Combine
(p1 | p2) / (p3 | p4)
```

## Step 12: Export Results

```{r export-results, eval=FALSE}
# Export differential expression results
de_results_8h %>%
  arrange(p_adjusted) %>%
  write_csv("differential_expression_results.csv")

# Export normalized counts
normalized_counts %>%
  select(gene_id, gene_name, sample_id, tpm) %>%
  write_csv("normalized_expression_values.csv")

# Export summary statistics
gene_set_summary %>%
  write_csv("gene_set_summary.csv")
```

## Key Findings

1. **Sample Quality**: All samples cluster appropriately by condition in PCA, indicating good experimental design and technical quality

2. **Differential Expression**:
   - 45 genes significantly differentially expressed at 8h (FDR < 0.05)
   - Immune response and ISGs show strongest upregulation
   - Metabolic genes tend to be downregulated

3. **Temporal Dynamics**:
   - Interferon-stimulated genes respond early (8h) and continue increasing
   - Antiviral genes show delayed but strong response at 24h
   - Sustained immune activation throughout infection

4. **Functional Patterns**:
   - Clear enrichment of immune and antiviral pathways
   - Coordinated response involving multiple gene families
   - Metabolic reprogramming during infection

## Practice Exercises

```{r exercises, eval=FALSE}
# Exercise 1: Perform differential expression analysis for 24h vs mock
# Compare results to 8h - which genes appear later?


# Exercise 2: Identify genes that are upregulated at 8h but return to baseline by 24h


# Exercise 3: Create a scatter plot comparing log2FC at 8h vs 24h
# Which genes show time-dependent expression?


# Exercise 4: Calculate the correlation between replicates for mock samples
# Are the replicates consistent?


# Exercise 5: Identify the top 5 most variable genes across all samples
# Hint: Calculate coefficient of variation


```

## Advanced Challenge

Create a function that takes a gene name and plots its expression across all samples with individual points and mean ± SE:

```{r challenge, eval=FALSE}
plot_gene_expression <- function(gene_name_input) {
  # Your code here
}

# Test it
plot_gene_expression("ISG_1")
```

## Key Takeaways

- RNA-seq analysis involves multiple steps: QC, normalization, DE analysis, and visualization
- PCA is essential for identifying sample relationships and potential batch effects
- Volcano plots effectively visualize thousands of genes simultaneously
- Heatmaps reveal expression patterns across samples
- Time course data provides insights into dynamic biological processes
- Gene set analysis connects individual genes to biological functions
- Always validate findings with functional annotations

## Additional Resources

- **DESeq2 package**: Standard tool for RNA-seq DE analysis
- **edgeR package**: Alternative DE analysis method
- **clusterProfiler**: Gene set enrichment analysis
- **ComplexHeatmap**: Advanced heatmap visualizations
- **Gene Ontology (GO)**: Functional annotation database

---

**Next Steps**: In Lesson 9, we'll analyze microbiome data with taxonomic abundances and diversity metrics!
